name: Build All FXServer Versions

on:
  schedule:
    - cron: '0 4 * * *'  # Daily at 4â€¯AM UTC
  workflow_dispatch:

jobs:
  build-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Fetch build list
        id: get_builds
        run: |
          curl -fsSL https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/ \
            | grep -Eo '[0-9]+-[a-f0-9]{40}' \
            | sort -n > builds_all.txt

      - name: Build and tag
        run: |
          while IFS= read -r build; do
            short="${build%%-*}"

            # Check for build on docker hub
            echo "Checking if $short exists on Docker Hub..."
            if curl -s "https://registry.hub.docker.com/v2/repositories/lilthrasher/fxserver/tags/$short" | grep -q '"name"'; then
              echo "âœ”ï¸ $short already exists â€” skipping."
              continue
            fi

            # Build docker container and push to docker hub
            echo "ğŸ› ï¸ Building FXServer $build (tag: $short)"
            docker build --build-arg FX_BUILD="$build" -t lilthrasher/fxserver:"$short" .
            echo "ğŸ“¦ Pushing to Docker Hub at lilthrasher/fxserver:"$short""
            docker push lilthrasher/fxserver:"$short"

            # Remove image from runner
            echo "ğŸ§¹ Cleaning up Builds from Runner"
            docker system prune -a -f

            # Send build notification
            curl \
              -H "Title: âœ… FXServer build completed successfully." \
              -d "Version "$short" built successfully." \
              ${{ secrets.NTFY_URL }}
          done < builds_all.txt